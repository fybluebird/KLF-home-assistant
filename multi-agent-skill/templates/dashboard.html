<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­ç®¡å®¶ç³»ç»Ÿ - æ§åˆ¶é¢æ¿</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 15px;
        }
        
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab:hover { background: rgba(255,255,255,0.2); }
        .tab.active {
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            color: #000;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .card h3 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.online { background: #00ff88; }
        .status-dot.offline { background: #ff6b6b; }
        
        /* æ™ºèƒ½ä½“ç½‘æ ¼ */
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .agent-card {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            border-left: 3px solid #00d9ff;
        }
        
        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .agent-name { font-size: 1.2em; font-weight: bold; }
        .agent-id { 
            background: rgba(0,217,255,0.2); 
            padding: 2px 8px; 
            border-radius: 10px; 
            font-size: 0.8em;
        }
        
        .agent-role { color: #888; margin-bottom: 8px; }
        .agent-desc { color: #aaa; font-size: 0.9em; }
        
        .btn {
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            color: #000;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }
        .btn:hover { opacity: 0.9; }
        
        /* ä»»åŠ¡åˆ—è¡¨ */
        .task-list { max-height: 400px; overflow-y: auto; }
        
        .task-item {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #ff6b6b;
        }
        .task-item.completed { border-left-color: #00ff88; }
        .task-item.cancelled { border-left-color: #888; }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .progress-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            transition: width 0.5s;
        }
        
        .task-meta {
            font-size: 0.8em;
            color: #888;
        }
        
        /* ç³»ç»Ÿèµ„æº */
        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .resource-item {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .resource-value {
            font-size: 1.8em;
            font-weight: bold;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .resource-label {
            color: #888;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        /* å¯¹è¯å¼¹çª— */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        
        .modal.active { display: flex; align-items: center; justify-content: center; }
        
        .modal-content {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
        }
        
        textarea {
            width: 100%;
            height: 100px;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            padding: 10px;
            resize: none;
        }
        
        .chat-history {
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }
        
        .chat-msg {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 6px;
        }
        .chat-msg.user { background: rgba(0,217,255,0.2); text-align: right; }
        .chat-msg.assistant { background: rgba(0,255,136,0.1); }
        
        /* æ›´æ–°æ—¶é—´ */
        .update-time {
            text-align: center;
            color: #666;
            font-size: 0.8em;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- æ ‡ç­¾é¡µ -->
    <div class="tabs">
        <button class="tab active" onclick="showTab('dashboard')">æ€»è§ˆ</button>
        <button class="tab" onclick="showTab('agents')">æ™ºèƒ½ä½“</button>
        <button class="tab" onclick="showTab('tasks')">ä»»åŠ¡</button>
        <button class="tab" onclick="showTab('history')">å†å²</button>
        <button class="tab" onclick="showTab('system')">ç³»ç»Ÿ</button>
    </div>
    
    <!-- æ€»è§ˆ -->
    <div id="dashboard" class="tab-content active">
        <div class="card">
            <h3>ğŸ“Š æ¦‚è§ˆ</h3>
            <div class="resource-grid">
                <div class="resource-item">
                    <div class="resource-value" id="agentCount">0</div>
                    <div class="resource-label">æ™ºèƒ½ä½“</div>
                </div>
                <div class="resource-item">
                    <div class="resource-value" id="taskCount">0</div>
                    <div class="resource-label">è¿›è¡Œä¸­ä»»åŠ¡</div>
                </div>
                <div class="resource-item">
                    <div class="resource-value" id="memoryCount">0</div>
                    <div class="resource-label">è®°å¿†æ¡ç›®</div>
                </div>
                <div class="resource-item">
                    <div class="resource-value" id="scheduleCount">0</div>
                    <div class="resource-label">ä»Šæ—¥æ—¥ç¨‹</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>ğŸ¤– æ™ºèƒ½ä½“çŠ¶æ€</h3>
            <div id="agentList" class="agent-grid"></div>
        </div>
    </div>
    
    <!-- æ™ºèƒ½ä½“ -->
    <div id="agents" class="tab-content">
        <div class="card">
            <h3>ğŸ¤– æ‰€æœ‰æ™ºèƒ½ä½“</h3>
            <div id="allAgents" class="agent-grid"></div>
        </div>
    </div>
    
    <!-- ä»»åŠ¡ -->
    <div id="tasks" class="tab-content">
        <div class="card">
            <h3>ğŸ“‹ è¿›è¡Œä¸­çš„ä»»åŠ¡</h3>
            <div id="taskList" class="task-list"></div>
        </div>
    </div>
    
    <!-- å†å² -->
    <div id="history" class="tab-content">
        <div class="card">
            <h3>ğŸ“œ å†å²ä»»åŠ¡</h3>
            <div id="historyList" class="task-list"></div>
        </div>
    </div>
    
    <!-- ç³»ç»Ÿ -->
    <div id="system" class="tab-content">
        <div class="card">
            <h3>ğŸ’» ç³»ç»Ÿèµ„æº</h3>
            <div class="resource-grid">
                <div class="resource-item">
                    <div class="resource-value" id="cpuPercent">0%</div>
                    <div class="resource-label">CPU</div>
                </div>
                <div class="resource-item">
                    <div class="resource-value" id="memPercent">0%</div>
                    <div class="resource-label">å†…å­˜</div>
                </div>
                <div class="resource-item">
                    <div class="resource-value" id="diskPercent">0%</div>
                    <div class="resource-label">ç£ç›˜</div>
                </div>
                <div class="resource-item">
                    <div class="resource-value" id="uptime">0h</div>
                    <div class="resource-label">è¿è¡Œæ—¶é—´</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>ğŸŒ æœåŠ¡çŠ¶æ€</h3>
            <div id="serviceStatus"></div>
        </div>
    </div>
    
    <div class="update-time">æœ€åæ›´æ–°: <span id="lastUpdate">--:--:--</span></div>
    
    <!-- å¯¹è¯å¼¹çª— -->
    <div id="chatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">ä¸æ™ºèƒ½ä½“å¯¹è¯</h3>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="chat-history" id="chatHistory"></div>
            <textarea id="chatInput" placeholder="è¾“å…¥ä»»åŠ¡æè¿°..."></textarea>
            <button class="btn" onclick="sendTask()">å‘é€ä»»åŠ¡</button>
        </div>
    </div>

    <script>
        let currentAgent = null;
        let updateIntervals = {};
        
        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }
        
        // è·å–æ•°æ®
        async function fetchData() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                updateUI(data);
            } catch (e) {
                console.error('è·å–æ•°æ®å¤±è´¥:', e);
            }
        }
        
        function updateUI(data) {
            const now = new Date().toLocaleTimeString();
            document.getElementById('lastUpdate').textContent = now;
            
            // æ€»è§ˆæ•°æ®
            document.getElementById('agentCount').textContent = data.agents.length;
            document.getElementById('taskCount').textContent = data.activeTaskCount;
            document.getElementById('memoryCount').textContent = data.totalMemories;
            document.getElementById('scheduleCount').textContent = data.todaySchedules;
            
            // æ™ºèƒ½ä½“åˆ—è¡¨
            const agentList = document.getElementById('agentList');
            const allAgents = document.getElementById('allAgents');
            const agentsHtml = data.agents.map(agent => `
                <div class="agent-card">
                    <div class="agent-header">
                        <span class="agent-name">${agent.mainName}</span>
                        <span class="agent-id">${agent.id}</span>
                    </div>
                    <div class="agent-role">${agent.role}</div>
                    <div class="agent-desc">${agent.description || 'æš‚æ— æè¿°'}</div>
                    <button class="btn" onclick="openChat('${agent.id}', '${agent.mainName}')">åˆ†é…ä»»åŠ¡</button>
                </div>
            `).join('');
            agentList.innerHTML = agentsHtml;
            allAgents.innerHTML = agentsHtml;
            
            // ä»»åŠ¡åˆ—è¡¨
            const taskList = document.getElementById('taskList');
            if (data.tasks.length === 0) {
                taskList.innerHTML = '<div style="text-align:center;color:#888;padding:20px;">æš‚æ— è¿›è¡Œä¸­çš„ä»»åŠ¡</div>';
            } else {
                taskList.innerHTML = data.tasks.map(task => `
                    <div class="task-item">
                        <div class="task-header">
                            <span>${task.content}</span>
                            <span class="status-dot ${task.isStuck ? 'offline' : 'online'}"></span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width:${task.progress}"></div>
                        </div>
                        <div class="task-meta">
                            è¿›åº¦: ${task.progress} | çŠ¶æ€: ${task.status} | æ›´æ–°æ—¶é—´: ${task.updatedAt}
                        </div>
                        <div style="display:flex;gap:10px;margin-top:10px;">
                            <button class="btn" style="flex:1;background:#00ff88;" onclick="completeTask('${task.id}')">å®Œæˆ</button>
                            <button class="btn" style="flex:1;background:#ff6b6b;" onclick="cancelTask('${task.id}')">å–æ¶ˆ</button>
                        </div>
                    </div>
                `).join('');
            }
            
            // å†å²ä»»åŠ¡
            const historyList = document.getElementById('historyList');
            if (data.historyTasks.length === 0) {
                historyList.innerHTML = '<div style="text-align:center;color:#888;padding:20px;">æš‚æ— å†å²ä»»åŠ¡</div>';
            } else {
                historyList.innerHTML = data.historyTasks.map(task => `
                    <div class="task-item ${task.status === 'å·²å®Œæˆ' ? 'completed' : 'cancelled'}">
                        <div class="task-header">
                            <span>${task.content}</span>
                            <span>${task.progress}</span>
                        </div>
                        <div class="task-meta">${task.status} | ${task.updatedAt}</div>
                    </div>
                `).join('');
            }
            
            // ç³»ç»Ÿèµ„æº
            document.getElementById('cpuPercent').textContent = data.system.cpu + '%';
            document.getElementById('memPercent').textContent = data.system.memory;
            document.getElementById('diskPercent').textContent = data.system.disk;
            document.getElementById('uptime').textContent = data.system.uptime;
            
            // æœåŠ¡çŠ¶æ€
            const serviceStatus = document.getElementById('serviceStatus');
            serviceStatus.innerHTML = `
                <div style="display:flex;gap:20px;flex-wrap:wrap;">
                    <span><span class="status-dot online"></span> Ollama: ${data.system.ollama}</span>
                    <span><span class="status-dot online"></span> Dashboard: è¿è¡Œä¸­</span>
                    <span><span class="status-dot online"></span> Cron: ${data.system.cron}</span>
                </div>
            `;
        }
        
        // å¯¹è¯å¼¹çª—
        function openChat(agentId, agentName) {
            currentAgent = { id: agentId, name: agentName };
            document.getElementById('modalTitle').textContent = 'ä¸ ' + agentName + ' å¯¹è¯';
            document.getElementById('chatModal').classList.add('active');
            document.getElementById('chatHistory').innerHTML = '<div style="color:#888;text-align:center;">ç­‰å¾…å‘é€ä»»åŠ¡...</div>';
            document.getElementById('chatInput').value = '';
            document.getElementById('chatInput').focus();
        }
        
        function closeModal() {
            document.getElementById('chatModal').classList.remove('active');
            currentAgent = null;
        }
        
        async function sendTask() {
            const input = document.getElementById('chatInput');
            const task = input.value.trim();
            if (!task || !currentAgent) return;
            
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.innerHTML += '<div class="chat-msg user"><strong>ä½ ï¼š</strong>' + task + '</div>';
            chatHistory.innerHTML += '<div class="chat-msg assistant"><strong>ç³»ç»Ÿï¼š</strong>ä»»åŠ¡å·²å‘é€ï¼Œç­‰å¾…æ‰§è¡Œ...</div>';
            input.value = '';
            
            try {
                await fetch('/api/task', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({agentId: currentAgent.id, task: task})
                });
            } catch (e) {
                console.error('å‘é€å¤±è´¥:', e);
            }
        }
        
        // å¯åŠ¨å®æ—¶æ›´æ–°
        function startRealTimeUpdates() {
            // æ¯3ç§’æ›´æ–°æ‰€æœ‰æ•°æ®
            fetchData();
            setInterval(fetchData, 3000);
            
            // ç³»ç»Ÿèµ„æºæ¯2ç§’æ›´æ–°
            setInterval(() => {
                fetch('/api/system').then(r => r.json()).then(data => {
                    document.getElementById('cpuPercent').textContent = data.cpu + '%';
                    document.getElementById('memPercent').textContent = data.memory;
                    document.getElementById('diskPercent').textContent = data.disk;
                    document.getElementById('uptime').textContent = data.uptime;
                });
            }, 2000);
        }
        
        async function completeTask(taskId) {
            const result = prompt('è¯·è¾“å…¥ä»»åŠ¡ç»“æœï¼ˆå¯é€‰ï¼‰:');
            if (result !== null) {
                try {
                    await fetch('/api/task/complete', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({taskId: taskId, result: result || ''})
                    });
                    alert('ä»»åŠ¡å·²å®Œæˆï¼ŒQQæ¶ˆæ¯å·²å‘é€ï¼');
                } catch (e) {
                    alert('æ“ä½œå¤±è´¥: ' + e);
                }
            }
        }
        
        async function cancelTask(taskId) {
            if (confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                try {
                    await fetch('/api/task/cancel', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({taskId: taskId})
                    });
                    alert('ä»»åŠ¡å·²å–æ¶ˆï¼ŒQQæ¶ˆæ¯å·²å‘é€ï¼');
                } catch (e) {
                    alert('æ“ä½œå¤±è´¥: ' + e);
                }
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶å¯åŠ¨
        startRealTimeUpdates();
    </script>
</body>
</html>
